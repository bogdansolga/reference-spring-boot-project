name: Test on Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  test:
    name: Build & Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run tests
        id: test
        run: mvn -B test 2>&1 | tee test-output.txt
        continue-on-error: true

      - name: Display tests summary
        if: always()
        run: |
          # Strip ANSI color codes from output
          sed 's/\x1b\[[0-9;]*m//g' test-output.txt > test-output-clean.txt

          # Extract only the final Results summary
          grep -A 2 "^\[INFO\] Results:" test-output-clean.txt > test-results.txt || echo "[INFO] No test results found" > test-results.txt

          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.test.outcome }}" = "success" ]; then
            echo "✅ **Tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Tests failed**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat test-results.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Set tests result
        id: result
        run: |
          if [ "${{ steps.test.outcome }}" = "failure" ]; then
            echo "failed=true" >> $GITHUB_OUTPUT
          else
            echo "failed=false" >> $GITHUB_OUTPUT
          fi

    outputs:
      test_failed: ${{ steps.result.outputs.failed }}

  comment-on-failure:
    name: Comment on Test Failure
    runs-on: ubuntu-latest
    needs: test
    if: needs.test.outputs.test_failed == 'true'

    steps:
      - name: Add failure comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '@claude describe the tests failure'
            })
